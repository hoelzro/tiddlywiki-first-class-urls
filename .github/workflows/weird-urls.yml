name: weird-urls
on:
  push:
    branches:
    - main
    - actions-upgrade
jobs:
  gather-the-weird:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
    - name: run-server
      run: |-
        git submodule init
        git submodule update
        npm install --production
        make build
        make -C log-routes-plugin/ build
        ip addr show docker0 | perl -nle 'if(my ( $addr ) = /inet\s+([.\d]+)/) { print "TIDDLYWIKI_HOST=$addr"; last }' >> $GITHUB_ENV
        DEBUG=1 TIDDLYWIKI_HOST=0.0.0.0 bash serve-temp-wiki &
    - name: gather-the-weird
      uses: docker://cypress/included:5.6.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        entrypoint: ./run-weird-urls
